const quiz=[
 {q:"What is the primary goal of processing instruments?", options:["Reducing equipment costs","Preventing nosocomial infections","Speeding procedures","Improving appearance","Replacing hand hygiene"],answer:1},
 {q:"Which process removes soil using water and detergents?", options:["Sterilization","High Level Disinfection","Cleaning","Disinfestation","Incineration"],answer:2},
 {q:"Which alcohol concentration is most effective?", options:["10%","50%","70%","95%","99%"],answer:2},
 {q:"What is the standard temperature for autoclaving?", options:["100°C","121°C","160°C","180°C","200°C"],answer:1},
 {q:"Which method uses friction and fluidics?", options:["Mechanical cleaning","Manual cleaning","Dry heat","Gas plasma","Chemical soaking"],answer:0},
 {q:"Which agent preserves fresh tissue?", options:["Glutaraldehyde","Chlorine","Formaldehyde","Hydrogen Peroxide","Peracetic acid"],answer:2},
 {q:"How long in 180°C dry heat?", options:["10 min","30 min","1 hr","2 hrs","12 hrs"],answer:3},
 {q:"Ideal disinfectant characteristic?", options:["High toxicity","Pleasant/no odor","High cost","Corrosive","Slow action"],answer:1},
 {q:"Terminal disinfection refers to?", options:["During illness","After recovery/death","Needle disposal","Hand washing","Blade sterilization"],answer:1},
 {q:"Which gas is used for low-temp sterilization?", options:["Oxygen","CO₂","Ethylene Oxide","Nitrogen","Chlorine"],answer:2}
];

let i=0, score=0, selected=null, timeLeft=450, totalTime=450, timer;
let failedQuestions = [];
let quizStarted = false;
const letters = ['A', 'B', 'C', 'D', 'E'];

// --- ANTI-CHEAT OVERRIDES ---

// Disable Right Click
document.addEventListener('contextmenu', event => event.preventDefault());

// Disable Key Shortcuts (F12, Ctrl+Shift+I, PrintScreen)
document.onkeydown = function(e) {
    if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || (e.ctrlKey && e.keyCode == 85)) {
        return false;
    }
    if (e.key === "PrintScreen") {
        navigator.clipboard.writeText(""); // Clear clipboard
        alert("Screenshots are disabled!");
    }
};

// Auto-Submit if user leaves the tab
document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === 'hidden' && quizStarted) {
        finish("Cheat Detection: Tab Switched/Minimized");
    }
});

// --- CORE FUNCTIONS ---

document.getElementById("startBtn").onclick=()=>{
    const name = document.getElementById("name").value.trim();
    const reg = document.getElementById("reg").value.trim();
    
    if(!name || !reg){
        alert("Details required"); return;
    }
    
    quizStarted = true;
    // Immediate logging of start attempt
    sendDataToSheet(name, reg, "STARTED - IN PROGRESS");
    
    document.getElementById("startScreen").style.display="none";
    document.getElementById("quizScreen").style.display="block";
    loadQuestion(); 
    startTimer();
};

function startTimer(){
    timer=setInterval(()=>{
        timeLeft--; 
        document.getElementById("time").textContent=timeLeft;
        if(timeLeft<=0){ finish("Time Expired"); }
    },1000);
}

function loadQuestion(){
    selected=null; 
    document.getElementById("feedback").textContent="";
    document.getElementById("submitBtn").style.display="block"; 
    document.getElementById("nextBtn").style.display="none";
    document.getElementById("progressBar").style.width = ((i) / quiz.length * 100) + "%";

    const q=quiz[i];
    document.getElementById("question").textContent=(i+1)+". "+q.q;
    const container = document.getElementById("options");
    container.innerHTML="";
    
    q.options.forEach((o,idx)=>{
        let d=document.createElement("div");
        d.className="option"; 
        d.innerHTML=`<div class="letter-box">${letters[idx]}</div> <span>${o}</span>`;
        d.onclick=()=>{
            document.querySelectorAll(".option").forEach(x=>x.classList.remove("selected"));
            d.classList.add("selected"); 
            selected=idx;
            // Immediate Answer Submission (Tricky part)
            processAnswer(); 
        }
        container.appendChild(d);
    });
}

function processAnswer() {
    if(selected===null) return;
    
    if(selected===quiz[i].answer){
        score++; 
    } else {
        failedQuestions.push({
            q: quiz[i].q,
            correct: quiz[i].options[quiz[i].answer]
        });
    }
    
    // Auto-advance logic
    document.getElementById("submitBtn").style.display="none"; 
    document.getElementById("nextBtn").style.display="block";
    
    // Optional: Auto-click next after 1 second for strictness
    setTimeout(() => {
        if(document.getElementById("nextBtn").style.display === "block") {
            document.getElementById("nextBtn").click();
        }
    }, 1500);
}

document.getElementById("nextBtn").onclick=()=>{ i++; i<quiz.length?loadQuestion():finish(); };

function sendDataToSheet(name, reg, scoreVal) {
    const url = "https://script.google.com/macros/s/AKfycbyR7A_u8zRWCG4GzhntPb123kqThgIjvBbbTEWtZKNRLN28wA2RZhUDDA2-ULUVo0DI/exec";
    const data = { name: name, reg: reg, score: scoreVal };
    fetch(url, { method: "POST", mode: "no-cors", cache: "no-cache", body: JSON.stringify(data) });
}

function finish(reason = "Completed") {
    if(!quizStarted) return;
    quizStarted = false;
    clearInterval(timer);
    
    const nameVal = document.getElementById("name").value;
    const regVal = document.getElementById("reg").value;
    const scoreFraction = score + "/" + quiz.length + ` (${reason})`;
    
    sendDataToSheet(nameVal, regVal, scoreFraction);

    document.getElementById("quizScreen").style.display = "none";
    document.getElementById("resultScreen").style.display = "block";
    
    let p = Math.round((score/quiz.length)*100);
    let timeSpent = totalTime - timeLeft;

    document.getElementById("resName").textContent = nameVal;
    document.getElementById("resReg").textContent = regVal;
    document.getElementById("resScore").textContent = scoreFraction;
    document.getElementById("resTime").textContent = `${Math.floor(timeSpent/60)}m ${timeSpent%60}s`;
    document.getElementById("resAccuracy").textContent = p + "%";
    document.getElementById("scoreDisplay").textContent = p + "%";
    
    if(failedQuestions.length > 0) {
        document.getElementById("failContainer").style.display = "block";
        document.getElementById("failedArea").innerHTML = failedQuestions.map((item, idx) => `
            <div class="fail-item">
                <strong>${item.q}</strong><br>
                Correct: <span class="correct-ans">${item.correct}</span>
            </div>
        `).join('');
    }

    const msg = document.getElementById("message");
    msg.textContent = p >= 50 ? "Excellent Mastery!" : "Usilale Bila Kusoma!";
    msg.className = p >= 50 ? "pass" : "fail";
}
